\section{Обзор численных методов \label{methods}}
В этой главе мы рассматриваем методы численного решения нелинейных уравнений, которые применялись в рамках данной работы. Методы использовались для решения уравнения теплопроводности \eqref{eq:heat_equation_intro} и системы функционала плотности \eqref{eq:dhd_system_intro}. Выбор именно этих методов обусловлен гладкостью всех функций, составляющих исследуемые задачи. Мы не рассматриваем разрывные решения и ударные волны.
\par 
Для простоты применение методов объясняется на примере уравнения теплопроводности, однако это не ограничивает сферу их применения.
\subsection{Аппроксимация производной по пространству \label{methods:space_derivative}}
Область $D$ разбивается по каждому направлению с равномерным шагом $h_i$, образуя сетку $\{x_m\}; \quad m = \overline{0 \dots M-1}$. В многомерном случае сетка получается декартовым произведением одномерных сеток. Мы применяем метод 2 порядка аппроксимации по пространству.  Для этого используется формула центральной разности, которая вычисляет значение производной в точке посередине между соседними точками сетки. По каждой оси вводятся вспомогательные сетки $\{ x_{m+0.5}\}$,  $\{ y_{m+0.5}\}$ и  $\{ z_{m+0.5}\}$, где $m = \overline{0 \dots M-2}$. Узлы находятся между узлами обычной сетки по данной оси:
\begin{equation}
x_{m + 0.5} = \frac{x_m + x_{m+1}}{2};
\quad
y_{m + 0.5} = \frac{y_m + y_{m+1}}{2};
\quad
z_{m + 0.5} = \frac{z_m + z_{m+1}}{2}
\end{equation}

\par
Продемонстрируем пользу дополнительной сетки на примере одномерного уравнения теплопроводности \eqref{eq:heat_equation_intro}. Мы используем для внутренней производной формулу центральной разности со 2 порядком аппроксимации, производная находится в узлах сетки $\{ x_{m+0.5}\}$:
\begin{equation}
\left.\frac{\partial u}{\partial x_i} \right\vert_{m+0.5}= \frac{u_{m+1} - u_m}{h} + O(h^2)
\end{equation}
Оператор дифференцирования по пространству в одномерном уравнении теплопроводности имеет такой вид:
\begin{equation}
\frac{\partial}{\partial x} \left( \alpha(u) \frac{\partial u}{\partial x}\right)
\end{equation}
Для вычисления $\alpha(u)$ на $\{ x_{m+0.5}\}$ используем линейную интерполяцию, поскольку функции $\alpha$ и $u$ непрерывны:
\begin{equation}
\alpha_{m+0.5} = \alpha(\frac{u_{m+1} + u_{m}} {2});
\quad 
\alpha_{m-0.5} = \alpha(\frac{u_{m} + u_{m - 1}} {2})
\end{equation}
Внешняя производная переводит значения снова на сетку $\{ x_m \}$ по формуле центральной разности. Таким образом, дискретизация оператора имеет вид:
\begin{equation}
\frac{\partial }{\partial x} \left( \alpha (u) \frac{\partial u}{\partial x} \right)  = \frac{1}{h_x} \left( \alpha_{m+0.5} \frac{u_{m+1} - u_m}{h_x} - \alpha_{m-0.5} \frac{u_{m} - u_{m-1}}{h_x} \right) + O(h_x^2)
\end{equation}
Благодаря дополнительной сетке мы достигаем 2 порядка аппроксимации производных по пространству.
\subsection{Интегрирование по времени \label{methods:time_integration}}
Перейдем к аппроксимации производной по времени. В рассматриваемых в данной работе задачах используется только первая производная по времени. Поэтому после дискретизации по пространству все эти задачи можно представить в виде:
\begin{equation} \label{eq:time_problem_general}
\frac{\partial \vec u}{\partial t} + F(\vec u) = 0
\end{equation}
где $\vec u$ - значения всех неизвестных в узлах сетки, а $F(\vec u)$ - некоторый нелинейный оператор, включающий в себя производные по пространству. 
\par
Введем сетку по времени $\{t_n\}$ разбиением отрезка $[0, T]$ на неравномерные шаги $\tau_n$. Будем использовать обозначение $\vec {u^n}$ для численного решения на неизвестном слое по времени, $\vec{u^{n - k}}$, $k \in \mathbb{N}$ - для известных. Когда номер шага $\tau_n$ понятен из контекста, будем использовать символ $\tau$ без индекса.
\par
Методы аппроксимации производной по времени делятся на 2 типа: \textit{явные} и \textit{неявные}. \textit{Явные методы} аппроксимируют производную по времени на слое $n - 1$:  $\left. \frac{\partial \vec u}{\partial t} \right \vert_{n-1} \approx F(\vec {u^{n-1}})$. Применение явного метода дает вид формулы, по которой можно вычислить $\vec{u^n}$. \textit{Неявные методы} аппроксимируют производную на неизвестном слое $n$ или между известным и неизвестным слоем: $\left. \frac{\partial \vec u}{\partial t} \right\vert_{n} \approx F(\vec {u^{n}})$. Функция в правой части зависит от значений на неизвестном слое. Необходимо решать систему уравнений относительно $\vec{u^n}$.
\subsubsection{Явный метод Эйлера}
\begin{equation}
\left. \frac{\partial \vec u}{\partial t} \right \vert_{n - 1} = \frac{\vec {u^n} - \vec {u^{n-1}}}{\tau} + O(\tau)
\end{equation}
Как известно, для явных методов шаг по времени  $\tau$ ограничивается условием устойчивости. Например, для линейного уравнения теплопроводности:
\begin{equation}
\alpha \cdot \tau \leq \frac{1}{2} \left( \sum_{a=1}^d \frac{1}{h_a^2}\right)^{-1}
\end{equation}
где $d$ - размерность пространства. Вывод условия устойчивости приведен в \cite{Samarskii}.
\subsubsection{Неявный метод Эйлера}
\begin{equation}
\left. \frac{\partial \vec u}{\partial t} \right \vert_{n} = \frac{\vec {u^n} - \vec {u^{n-1}}}{\tau} + O(\tau)
\end{equation}
\subsubsection{Трехточечная односторонняя разность второго порядка точности \label{methods:back-diff}}
Неявный метод Эйлера позволяет устойчиво делать большие шаги по времени, но его первый порядок по времени во многих случаях дает слишком малую точность. Поэтому мы также рассматриваем методы второго порядка по времени.
\begin{equation} 
\left. \frac{\partial \vec u}{\partial t} \right \vert_{n} = \frac{3 \vec {u^{n}} - 4 \vec {u^{n - 1}} + \vec {u^{n - 2}}} {2 \tau} + O(\tau^2)
\end{equation}
Данный метод является неявным. Он использует 2 предыдущих временных слоя, которые нужно хранить в памяти. Первый шаг делается \textit{методом Эйлера}. В \cite{Samarski-intro} доказывается абсолютная устойчивость этого метода.
\subsubsection{Метод Кранка-Николсона}
Можно получить 2 порядок аппроксимации по времени, не храня в памяти 3 временных слоя. Для этого производная по времени вычисляется по формуле центральной разности в точке: $t_{n-0.5} = \frac{t_{n} + t_{n-1}}{2}$. Формула центральной разности дает 2 порядок аппроксимации: 
\begin{equation}
\left. \frac{\partial \vec {u}}{\partial t} \right \vert_{n-0.5} = \frac{\vec {u^n} - \vec {u^{n-1}}}{\tau} + O(\tau ^ 2)
\end{equation}
Чтобы метод работал правильно, нужно взять правую часть уравнения \eqref{eq:time_problem_general} в момент времени $n-0.5$. 
Для источника $\vartheta$ это легко, поскольку он определен аналитически. Пространственную производную нужно будет интерполировать, так как мы получаем ее численно из значений на каждом временном слое:
\begin{equation}
\left. \frac{\partial \vec u}{\partial x} \right \vert_{n-0.5} = \frac{1}{2}\left( \left. \frac{\partial \vec u}{\partial x} \right \vert_{n} + \left. \frac{\partial \vec u}{\partial x} \right \vert_{n - 1} \right)
\end{equation}
Поэтому данный метод относится к \textit{неявным}. Он абсолютно устойчив, однако обладает ограничением асимптотической устойчивости. Для уравнения теплопроводности оно имеет такой вид:
\begin{equation}
\tau < \tau_0,
\quad
\tau_0 \approx \frac {h}{\pi}
\end{equation}
Данное условие получено в \cite{Samarski-intro}. Нарушение условия асимптотической устойчивости может приводить к нежелательным осцилляции в решении. Метод \ref{methods:back-diff} не накладывает такое условие.

\subsection{Подходы к решению многомерных неявных по времени задач}
Использование неявного метода интегрирования по времени приводит к нелинейной системе уравнений. Метод ее решения, который мы используем в данной работе, будет описан в разделе \ref{methods:newton}. Важно, что он представляет из себя многократное решение систем линейных уравнений на основе матрицы Якоби. 
\par 
Некоторые матрицы обладают определенной  \textit{тридиагональной} структурой. Как будет показано позже в разделе \ref{methods:tridiagonal}, систему с такой матрицей можно решить очень быстро. Вид тридиагональной матрицы приводится в \eqref{mat:tridiagonal}.
Тридиагональной структурой обладает, например, матрица Якоби одномерного уравнения теплопроводности \eqref{eq:heat_equation_intro}. Двумерное и трехмерное уравнения теплопроводности такой структурой не обладают, как и одномерная векторная система функционала плотности. 
\par
Во многих реальных задачах матрица не обладает тридиагональной структурой. Можно попытаться разбить каждый шаг по времени на несколько задач, каждая из которых будет сводиться к решению тридиагональной системы, либо использовать методы, не требующие тридиагональной структуры. Такие методы всегда будут требовать значительно больше операций. Таким образом, мы выделили 2 подхода к решению: 
\begin{enumerate}
\item Разбить на подзадачи
\item Использовать метод, не требующий тридиагональной структуры
\end{enumerate}
Покажем на примере, как разделять шаг по времени на подзадачи.
\subsubsection*{Метод переменных направлений \label{methods:alternate_directions}}
Решаем двумерное уравнение теплоповодности \eqref{eq:heat_equation_intro}. Шаг по времени разбивается на 2 части. Первая часть неявна по направлению $x$, а вторая - по $y$. Сначала методом прогонки вычисляются промежуточные значения $\tilde u$ в момент времени $t_{n - 0.5}$. Затем методом прогонки вычисляются значения $u^n$, используя известные $\tilde u$:
\begin{equation}
\begin{cases}
\tilde u_{mk} = f_1(\tilde u_{m, k \pm i}, u^{n - 1}_{m \pm i, k} ) 
\\ \\
u^{n}_{mk} = f_2(\tilde u_{m, k \pm i}, u^{n}_{m \pm i, k} )
\end{cases}
\quad i = 0, \pm 1
\end{equation}
Данный метод абсолютно устойчив, однако его трехмерный аналог неустойчив. Исследование устойчивости проводится в \cite{Sikovskii}.

\subsection*{}
Главный недостаток подхода, разбивающего шаг по времени на подзадачи - трудность его обобщения. Для каждой конкретной задачи нужно разрабатывать методы разбиения системы. После этого нужно исследовать разработанный метод на устойчивость. Если решается система более сложного вида, чем уравнение теплопроводности, разработка такого подхода сложна. Однако, если удастся получить и обосновать такой подход, вычислительная нагрузка при решении задачи сократится в разы. Мы не будем подробно останавливаться на разработке таких методов. Сосредоточимся на более общем подходе - будем решать разреженную систему, не привязываясь к ее конкретному виду.

\subsection{Решение нелинейных систем уравнений \label{methods:newton}}
Использование неявного метода интегрирования по времени приводит к нелинейной системе уравнений из $M$ уравнений с $M$ неизвестными вида:
\begin{equation}\label{eq:newtons_method_system}
\mathbf{F}(\mathbf{x}) = \mathbf{0}
\end{equation}
Для решения таких систем мы решили остановиться на \textit{методе Ньютона}, как на наиболее робастном методе для нашего типа задач. 
\subsubsection*{Метод Ньютона} Ищем точное решение $\mathbf{\tilde x}$ уравнения \eqref{eq:newtons_method_system}. Возьмем начальное приближение решения $\mathbf{x_0}$. Разложим в ряд Тейлора в окрестности $\mathbf{\tilde x}$ функцию $\mathbf{F}(\mathbf{x_0)}$:
\begin{equation}
\mathbf{F}(\mathbf{\tilde x}) \approx \mathbf{F}({\mathbf{x_0}}) + \mathbf{J}(\mathbf{x_0}) \cdot (\mathbf{\tilde x} - \mathbf{x_0})
\end{equation}
Здесь $\mathbf{J}$ - матрица Якоби (матрица частных производных по $\mathbf{x}$ функции $\mathbf{F}$). Заменим $\Delta \mathbf{x} = \mathbf{\tilde x} - \mathbf{x_0}$:
\begin{equation}
\mathbf{J}(\mathbf{x_0}) \cdot \Delta \mathbf{x} = - \mathbf{F}(\mathbf{x_0})
\end{equation}
Получаем систему уравнений, позволяющую приблизиться на $\Delta \mathbf{x}$ к искомому решению. Одной итерации алгоритма недостаточно, так как окрестность может быть не малой. Из-за этого в разложении в ряд Тейлора будет большая ошибка. Сделаем несколько таких итераций. Запишем итерационную формулу для последовательности $\mathbf{x^n}$, приближающейся к $\mathbf{\tilde x}$:
\begin{equation} \label{eq:newton_method}
\mathbf{J}(\mathbf{x^n}) \cdot \Delta \mathbf{x^n} = - \mathbf{F}(\mathbf{x^n})
\end{equation}
Критерием остановки является малость нормы невязки $\mathbf{F}(\mathbf{x^n}) = \mathbf{r^n};
\quad ||\mathbf{r^n}||< C$.
\par
Систему можно переписать в виде $\Delta \mathbf{x^n} = - \mathbf{J^{-1}}(\mathbf{x^n}) \cdot \mathbf{F}$. Тогда задача сводится к поиску обратной матрицы $\mathbf{J^{-1}}$. На практике легче решать именно систему, пользуясь ее разреженной структурой, а не искать обратную матрицу.
\subsubsection*{Применение метода Ньютона}
На каждой итерации метода Ньютона необходимо:
\begin{enumerate}
\item Вычислить матрицу Якоби для нелинейной системы
\item Решить систему линейных уравнений
\end{enumerate}
Оптимизации 1-го действия будут рассмотрены в главе \ref{implementation:operator_preconditioning}. Основная вычислительная нагрузка в методе Ньютона заключается в решении линейной системы уравнений, так как размерность матрицы $M \times M$ может быть очень большой. Выбор эффективного метода решения линейной системы - залог эффективности решения нелинейной задачи.

\input{2_methods-linear}
